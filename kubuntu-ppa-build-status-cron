#!/bin/sh

if [ ! -e ./kubuntu-ppa-build-status-cron.conf ]; then
    echo "config file missing. Not set up yet?"
    exit 1
fi

if [ -z "$KUBUNTU_PPA_BUILD_STATUS_CONFIG" ]; then
    . ./kubuntu-ppa-build-status-cron.conf
else
    . $KUBUNTU_PPA_BUILD_STATUS_CONFIG
fi

WORKDIR=`pwd`

[ -e $CACHEDIR ] || mkdir -p $CACHEDIR
[ -e $STATUSDIR ] || mkdir -p $STATUSDIR

if [ ! -w $CACHEDIR ]; then
    echo "$CACHEDIR not writable! Cannot continue"
    exit 2
elif [ ! -w $STATUSDIR ]; then
    echo "$STATUSDIR not writable! Cannot continue"
    exit 3
fi

cd $CACHEDIR
rm -f $FILE
wget https://$CREDENTIALS@private-ppa.launchpad.net/kubuntu-ninjas/ppa/ubuntu/dists/$RELEASE/$FILE
# check if we need to do something
# FIXME: this doesn't work for build failures...
if [ -e $FILE.old ]; then
    if [ ! "`stat --format=%Y $FILE`" -gt "`stat --format=%Y $FILE.old`" ]; then
        exit 0
    fi
fi
mv $FILE $FILE.old
cd $WORKDIR

# regenerate status page
./kubuntu-ppa-build-status -d $RELEASE -v $KDE_VERSION -c $LP_CREDENTIALS --cache $CACHEDIR > $STATUSDIR/build_status_${KDE_VERSION}_${RELEASE}.html.new
mv $STATUSDIR/build_status_${KDE_VERSION}_${RELEASE}.html.new $STATUSDIR/build_status_${KDE_VERSION}_${RELEASE}.html
